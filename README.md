# NixOS

My NixOS configuration.

## Structure

- **`modules/`** - Individual configuration units for specific tools and applications (e.g., git, zsh, hyprland).

- **`bundles/`** - Collections of related home-level modules to help make importing easier. Bundles are imported within the `home.nix` file of each profile. Modules that need to be imported at a system level are instead included in the appropriate `base/` file.

- **`base/`** - System-level configuration layers that contain system settings as well as system-level modules.

- **`profiles/`** - Complete machine templates combining system configuration from `base/` with user configuration from `bundles/`.

- **`hosts/`** - Hardware-specific configurations generated by `nixos-generate-config` for each physical machine. Each folder is a hostname for a different physical machine.

## Installation

Clone this repo, then create a symlink inside `/etc/nixos`

```sh
sudo rm -rf /etc/nixos
sudo ln -s ~/repos/nixos /etc/nixos
```

## Building

To rebuild and switch to the current configuration, use the easiest way is with the provided `ns` command:

```sh
ns
```

You can also use `ns <hostname>` to switch to a different profile (e.g., `ns t490`).

However, on a new machine that hasn't been set up yet, you'll need to use `nixos-rebuild` directly:

```sh
sudo nixos-rebuild switch --flake /etc/nixos#<hostname>
```

## Secrets

[SOPS](https://github.com/getsops/sops) is used to manage secrets, more specifically [sops-nix](https://github.com/Mic92/sops-nix). An [age](https://github.com/FiloSottile/age) key is automatically generated on each machine. Secrets are encrypted in Git, and automatically decrypted during NixOS activation.

To edit secrets, run:

```sh
sudo sops secrets.yaml
```

Or to just see them decrypted:

```sh
sudo sops -d secrets.yaml
```

### Adding a New Machine

When setting up a new machine, we need to add its public key to the `.sops.yaml` file to allow it to decrypt the secrets.

To view a machine's public key, there's a helpful alias:

```sh
age-key-show
```

Or you can run the full command directly:

```sh
sudo age-keygen -y /var/lib/sops-nix/key.txt
```

Now we need to re-encrypt the secrets with the new machine's public key. But, we can't do this from the new machine itself yet. So, commit the changed `.sops.yaml` file, then on an already authed machine run:

```sh
sudo sops updatekeys secrets.yaml
```
