# NixOS

My NixOS configuration.

## Structure

- **`modules/`** - Individual configuration units for specific tools and applications (e.g., git, zsh, hyprland).

- **`base/`** - System-level configuration layers that contain commonly shared system settings and packages.

- **`profiles/`** - Complete machine templates, each profile contains two files:

  - `configuraion.nix` - System-level settings and packages, contains imports from `base/` and system-level `modules/`.
  - `home.nix` - Home-level settings and packages, contains imports to user-level `modules/`.

- **`hosts/`** - Hardware-specific configurations generated by `nixos-generate-config` for each physical machine. Each folder is a hostname for a different physical machine.

- **`flake.nix`** - The main entry point for the NixOS configuration. Contains a `mkHost` helper function that helps map `hosts/` to `profiles/`.

## Installation

Clone this repo, then remove `/etc/nixos` and replace it with a symlink to this repo.

**Note:** Be sure to save your `hardware-configuration.nix` file from `/etc/nixos` before removing the directory.

```sh
sudo rm -rf /etc/nixos
sudo ln -s ~/repos/nixos /etc/nixos
```

## Building

To rebuild and switch to the current configuration, use the easiest way is with the provided `ns` command:

```sh
ns
```

You can also use `ns <hostname>` to switch to a different profile (e.g., `ns t490`).

However, on a new machine that hasn't been set up yet, you'll need to use `nixos-rebuild` directly:

```sh
sudo nixos-rebuild switch --flake /etc/nixos#<hostname>
```

## Secrets

[SOPS](https://github.com/getsops/sops) is used to manage secrets, more specifically [sops-nix](https://github.com/Mic92/sops-nix). This NixOS configuration is set up to generate an [age](https://github.com/FiloSottile/age) automatically on each machine. Secrets are encrypted in Git, and automatically decrypted during NixOS activation.

On an authenticated machine, to edit secrets, run:

```sh
sudo sops secrets.yaml
```

Or to just see them decrypted:

```sh
sudo sops -d secrets.yaml
```

### Adding a New Machine

When setting up a new machine, we need to add its public key to the `.sops.yaml` file to allow it to decrypt the secrets.

To view a machine's public key, there's a helpful alias:

```sh
age-key-show
```

Or you can run the full command directly:

```sh
sudo age-keygen -y /var/lib/sops-nix/key.txt
```

Now we need to re-encrypt the secrets with the new machine's public key. But, we can't do this from the new machine itself yet. So add the key to the `.sops.yaml` file, commit the new file, then on an already authed machine run:

```sh
sudo sops updatekeys secrets.yaml
```
